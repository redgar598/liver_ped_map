---
title: "Lung single cell"
output: html_document
date: "2022-09-15"
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
source("R_functions/pretty_plots.R")
```


## Load data
```{r}
tar_load(meta)
tar_load(d10x.list.mt)
tar_load(d10x.list.QC)
```


## Dim of data
```{r}
print(d10x_raw)
```





##   Visualize QC metrics
Low-quality cells or empty droplets will often have very few genes
Cell doublets or multiplets may exhibit an aberrantly high gene count
nFeature number of unique genes
nCount number of total molecules: already filtered at min 1000 unique genes
from geo page
Cells filtered with > 12% of transcriptome from intron-spanning reads; < 20% mitochondrial origin; at least 1000 unique genes

```{r}
plt_QC_data<-do.call(rbind, lapply(1:length(d10x.list.mt), function(x) d10x.list.mt[[x]]@meta.data))

qc_plts<-ggplot(plt_QC_data, aes(nCount_RNA,nFeature_RNA,colour=percent.mt)) + 
  geom_point() + 
  scale_color_gradientn(colors=c("black","blue","green2","red","yellow"),name="Percent\nMitochondrial") +
  geom_hline(yintercept = 500) + xlab("Number of Total Molecules\n(nCount) ")+ylab("Number of Unique Genes\n(nFeature)")+
  geom_hline(yintercept = 6000) +theme_bw()+th
qc_plts
save_plts(qc_plts, "intital_QC_plts", w=6,h=4)

qc_plts_chem<-ggplot(plt_QC_data, aes(nCount_RNA,nFeature_RNA,colour=percent.mt)) + 
  geom_point() + facet_wrap(~Chemistry)+
  scale_color_gradientn(colors=c("black","blue","green2","red","yellow"),name="Percent\nMitochondrial") +
  geom_hline(yintercept = 500) + xlab("Number of Total Molecules\n(nCount) ")+ylab("Number of Unique Genes\n(nFeature)")+
  geom_hline(yintercept = 6000) +theme_bw()+th
qc_plts_chem
save_plts(qc_plts_chem, "intital_QC_plts_chemistry", w=12,h=4)

qc_plts_individual<-ggplot(plt_QC_data, aes(nCount_RNA,nFeature_RNA,colour=percent.mt)) + 
  geom_point() + facet_wrap(~individual)+
  scale_color_gradientn(colors=c("black","blue","green2","red","yellow"),name="Percent\nMitochondrial") +
  geom_hline(yintercept = 500) + xlab("Number of Total Molecules\n(nCount) ")+ylab("Number of Unique Genes\n(nFeature)")+
  geom_hline(yintercept = 6000) +theme_bw()+th
qc_plts_individual
save_plts(qc_plts_chem, "intital_QC_plts_individual", w=12,h=4)

MT_plt<-ggplot(plt_QC_data,aes(percent.mt)) + geom_histogram(binwidth = 0.5) +
  geom_vline(xintercept = 10)+ theme_bw()+xlab("Percent Mitochondrial")+th
MT_plt
save_plts(MT_plt, "percentMT_plt", w=6,h=4)

MT_plt_individual<-ggplot(plt_QC_data,aes(percent.mt)) + geom_histogram(binwidth = 0.5) +
  facet_wrap(~individual, scales="free_y")+
  geom_vline(xintercept = 10)+ theme_bw()+xlab("Percent Mitochondrial")+th
MT_plt_individual
save_plts(MT_plt_individual, "percentMT_plt_individual", w=6,h=4)
```

#'Cell counts
```{r}
plt_count_raw<-lapply(1:length(d10x.list.mt), function(x) {
  df<-data.frame(raw_cell_count=nrow(d10x.list.mt[[x]]@meta.data),individual=unique(d10x.list.mt[[x]]@meta.data$individual))
  df})
plt_count_raw<-do.call(rbind, plt_count_raw)
print(plt_count_raw)

plt_count_QC<-lapply(1:length(d10x.list.QC), function(x) {
  df<-data.frame(qc_cell_count=nrow(d10x.list.QC[[x]]@meta.data),individual=unique(d10x.list.QC[[x]]@meta.data$individual))
  df})
plt_count_QC<-do.call(rbind, plt_count_QC)
print(plt_count_QC)

counts<-merge(plt_count_raw, plt_count_QC, by="individual")
meta<-merge(meta,counts,by.x="Sample_ID", by.y="individual")

cell_count<-grid.arrange(ggplot(meta, aes(AgeGroup, raw_cell_count,fill=AgeGroup))+
                           geom_boxplot()+geom_point()+
                           theme_bw()+geom_text(aes(label=Sample_ID), hjust=-0.25, size=3)+xlab("Age Group")+
                           ylab("Total Cell Number")+th+fillscale_age+
                           theme(legend.position = "none")+ggtitle("Before Quality Control"),
                         ggplot(meta, aes(AgeGroup, qc_cell_count,fill=AgeGroup))+
                           geom_boxplot()+geom_point()+
                           theme_bw()+geom_text(aes(label=Sample_ID), hjust=-0.25, size=3)+xlab("Age Group")+
                           ylab("Total Cell Number")+th+fillscale_age+
                           theme(legend.position = "none")+ggtitle("After Quality Control"), ncol=2)

save_plts(cell_count, "QC_cellcount_age", w=8,h=4)
```

